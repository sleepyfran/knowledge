<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>swiftui on sleepyfran's blog</title><link>https://sleepyfran.github.io/blog/tags/swiftui/</link><description>Recent content in swiftui on sleepyfran's blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 13 Jul 2022 15:43:39 +0200</lastBuildDate><atom:link href="https://sleepyfran.github.io/blog/tags/swiftui/index.xml" rel="self" type="application/rss+xml"/><item><title>Grouped queries in SwiftUI</title><link>https://sleepyfran.github.io/blog/posts/swift/coredata/swiftui-grouped-queries/</link><pubDate>Wed, 13 Jul 2022 15:43:39 +0200</pubDate><guid>https://sleepyfran.github.io/blog/posts/swift/coredata/swiftui-grouped-queries/</guid><description>Querying While developing Maby I needed to retrieve all events that happened, grouped by dates. Now of course I could just slap a FetchRequest and then manually group the results into a dictionary, specially given how easy it is with the grouping init, but it turns out that there&amp;rsquo;s a better way.
Since iOS/iPadOS/tvOS 15, macOS 12 and watchOS 8 there&amp;rsquo;s a new fetch request in town called SectionedFetchRequest that allows us to specify a type to group by and an entity to group, so for example in my case I could just do the following:</description><content>&lt;h2 id="querying">Querying&lt;/h2>
&lt;p>While developing &lt;a href="https://github.com/sleepyfran/maby/">Maby&lt;/a> I needed to retrieve all events that happened, grouped by dates. Now of course I could just slap a &lt;code>FetchRequest&lt;/code> and then manually group the results into a dictionary, specially given how easy it is with the &lt;a href="https://developer.apple.com/documentation/swift/dictionary/init(grouping:by:)">grouping init&lt;/a>, but it turns out that there&amp;rsquo;s a better way.&lt;/p>
&lt;p>Since iOS/iPadOS/tvOS 15, macOS 12 and watchOS 8 there&amp;rsquo;s a new fetch request in town called &lt;a href="https://developer.apple.com/documentation/swiftui/sectionedfetchrequest/">&lt;code>SectionedFetchRequest&lt;/code>&lt;/a> that allows us to specify a type to group by and an entity to group, so for example in my case I could just do the following:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>@SectionedFetchRequest&amp;lt;Date, Event&amp;gt;(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sectionIdentifier: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.start,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sortDescriptors: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SortDescriptor(&lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.start, order: .reverse)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> events: SectionedFetchResults&amp;lt;Date, Event&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>start&lt;/code> being the date property that I want to group by. With this, we can go ahead and use the results just like we would with a normal fetch request, but having to iterate two times: one for the groups, another for the items inside the group:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>ForEach(events) { section &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Section(header: Text(section.id, format: .dateTime)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ForEach(section) { event &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(event.name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In the code above, &lt;code>section.id&lt;/code> is the ID that we gave the &lt;code>SectionFetchRequest&lt;/code> to group, so in my case it&amp;rsquo;s a date and that&amp;rsquo;s why I have to specify the &lt;code>.dateTime&lt;/code> format for the text to show correctly. So the &lt;code>section&lt;/code> is a struct that acts as a collection, that&amp;rsquo;s why we can both grab the ID from it but also iterate over it with &lt;code>ForEach&lt;/code>.&lt;/p>
&lt;p>This would work if you chose something else than a date to group by, for example strings, numbers and the like work great for grouping, but with dates depending on how you store them and how you want to group them you&amp;rsquo;d find an issue just like I did here: I want to group by day, not by the whole date. An event that happened the 15th of August at 14:50 is the same as it happened at 14:30 for me. In order to fix this I simply introduced this computed property in my model:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">@objc&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> groupStart: Date {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> components = Calendar.current.dateComponents(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [.year, .month, .day],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> from: &lt;span style="color:#66d9ef">self&lt;/span>.start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> Calendar.current.date(from: components)&lt;span style="color:#f92672">!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This basically retrieves just the day, month and year from the date and returns a Date from it, effectively removing the time from it. With this, changing the grouping property to this computed one makes it work great:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>@SectionedFetchRequest&amp;lt;Date, Event&amp;gt;(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sectionIdentifier: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.groupStart,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sortDescriptors: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SortDescriptor(&lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.start, order: .reverse)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> events: SectionedFetchResults&amp;lt;Date, Event&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>(Note that I kept the original date as the sort descriptor so that the events still show ordered by date with the time taken into account)&lt;/em>&lt;/p>
&lt;h2 id="implementing-ondelete">Implementing &lt;code>onDelete&lt;/code>&lt;/h2>
&lt;p>With sectioned requests there&amp;rsquo;s just a tiny more work involved to support the deletions on the items:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>ForEach(events) { section &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Section(header: Text(section.id, format: .dateTime)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ForEach(section) { event &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(event.name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .onDelete { indexSet &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> indexSet.forEach {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> viewContext.delete(section[$0])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>(Note that I&amp;rsquo;m calling the view context&amp;rsquo;s delete method directly to keep the example small, feel free to change it for your preferred way of deleting)&lt;/em>&lt;/p>
&lt;p>Basically we need to rely on the &lt;code>section&lt;/code> that we&amp;rsquo;re iterating to retrieve the items, since the &lt;code>indexSet&lt;/code> that the &lt;code>onDelete&lt;/code> function gives us is relative to the &lt;strong>current&lt;/strong> group. However, since &lt;code>section&lt;/code> is iterable we can just grab each element by its index, easy!&lt;/p></content></item><item><title>Unrecognized selector `objectAtIndex`</title><link>https://sleepyfran.github.io/blog/posts/swift/coredata/unrecognized-selector-objectatindex/</link><pubDate>Tue, 21 Jun 2022 11:43:39 +0200</pubDate><guid>https://sleepyfran.github.io/blog/posts/swift/coredata/unrecognized-selector-objectatindex/</guid><description>Unrecognized selector objectAtIndex 2022-06-21 22:41:30.447763+0200 App[56115:1179524] -[__NSCFSet objectAtIndex:]: unrecognized selector sent to instance 0x600003df9c20 This happened with the following code, basically when trying to do a ForEach on a property coming from a CoreData model:
import CoreData import SwiftUI struct BudgetView: View { @FetchRequest(entity: CategoryGroup.entity(), sortDescriptors: []) var categoryGroups: FetchedResults&amp;lt;CategoryGroup&amp;gt; var body: some View { VStack { List { ForEach(categoryGroups, id: \.id) { group in Text(group.name) ForEach(group.categories, id: \.id) { category in Text(category.</description><content>&lt;h1 id="unrecognized-selector-objectatindex">Unrecognized selector &lt;code>objectAtIndex&lt;/code>&lt;/h1>
&lt;pre tabindex="0">&lt;code>2022-06-21 22:41:30.447763+0200 App[56115:1179524] -[__NSCFSet objectAtIndex:]: unrecognized selector sent to instance 0x600003df9c20
&lt;/code>&lt;/pre>&lt;p>This happened with the following code, basically when trying to do a &lt;code>ForEach&lt;/code> on a property coming from a CoreData model:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#a6e22e">CoreData&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#a6e22e">SwiftUI&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">BudgetView&lt;/span>: View {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @FetchRequest(entity: CategoryGroup.entity(), sortDescriptors: [])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> categoryGroups: FetchedResults&amp;lt;CategoryGroup&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> body: some View {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> VStack {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> List {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ForEach(categoryGroups, id: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.id) { group &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(group.name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ForEach(group.categories, id: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.id) { category &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(category.name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This property is actually declared manually as an array:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">CategoryGroup&lt;/span>: NSManagedObject, Identifiable {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">@NSManaged&lt;/span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> categories: [Category]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>But even though &lt;em>I&lt;/em> declared it as an array apparently the underlying type that CoreData actually puts there is an &lt;code>NSSet&lt;/code>, which by default does not allow to retrieve stuff by its index (does that unrecognized selector &lt;code>objectAtIndex&lt;/code> makes a bit more sense now?)&lt;/p>
&lt;p>The easy solution is to mark the property as &amp;ldquo;Ordered&amp;rdquo; in the CoreData model. The &lt;strong>proper&lt;/strong> solution, however, is to not interact with &lt;code>NSSet&lt;/code> directly unless we can avoid it, so we can simply introduce a computed variable that transforms our property into an array (or whatever other data type we need!):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">var&lt;/span> categoriesArray: [Category] {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> set = categories &lt;span style="color:#66d9ef">as&lt;/span>? Set&amp;lt;Category&amp;gt; ?? []
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">set&lt;/span>.sorted {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $0.id &lt;span style="color:#f92672">&amp;lt;&lt;/span> $1.id
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This casts the &lt;code>NSSet&lt;/code> into an array sorting it by their ID. Now instead of doing the &lt;code>ForEach&lt;/code> directly on the &lt;code>categories&lt;/code> property we have to use this computed one:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#a6e22e">CoreData&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> &lt;span style="color:#a6e22e">SwiftUI&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">BudgetView&lt;/span>: View {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @FetchRequest(entity: CategoryGroup.entity(), sortDescriptors: [])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> categoryGroups: FetchedResults&amp;lt;CategoryGroup&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> body: some View {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> VStack {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> List {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ForEach(categoryGroups, id: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.id) { group &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(group.name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* The change is here */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ForEach(group.categoriesArray, id: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.id) { category &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Text(category.name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></content></item></channel></rss>