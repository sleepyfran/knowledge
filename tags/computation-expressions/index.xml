<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>computation expressions on sleepyfran's blog</title><link>https://sleepyfran.github.io/blog/tags/computation-expressions/</link><description>Recent content in computation expressions on sleepyfran's blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 17 Dec 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://sleepyfran.github.io/blog/tags/computation-expressions/index.xml" rel="self" type="application/rss+xml"/><item><title>Creating DSLs using F#'s Computation Expressions</title><link>https://sleepyfran.github.io/blog/posts/fsharp/ce-in-fsharp/</link><pubDate>Sat, 17 Dec 2022 00:00:00 +0000</pubDate><guid>https://sleepyfran.github.io/blog/posts/fsharp/ce-in-fsharp/</guid><description>This article is part of the 2022 F# Advent Calendar. Go check out the other awesome posts that are part of it here!
As a user of F# I&amp;rsquo;ve been using lots of seq { } and async { } computation expressions, however I never really wrote my own. Lately I&amp;rsquo;ve been getting more and more into making DSLs and I found CEs to be an absolutely god-send for this.</description><content>&lt;blockquote>
&lt;p>This article is part of the 2022 F# Advent Calendar. Go check out the other awesome posts that are part of it &lt;a href="https://sergeytihon.com/2022/10/28/f-advent-calendar-in-english-2022/">here&lt;/a>!&lt;/p>
&lt;/blockquote>
&lt;p>As a user of F# I&amp;rsquo;ve been using lots of &lt;code>seq { }&lt;/code> and &lt;code>async { }&lt;/code> computation expressions, however I never really wrote my own. Lately I&amp;rsquo;ve been getting more and more into making DSLs and I found CEs to be an absolutely god-send for this. They can make the code really succinct and can help you turn messy code into a neat list of instructions that is easy to follow.&lt;/p>
&lt;p>So I thought that in this post we can make together a DSL that, inspired by &lt;a href="https://github.com/joshdholtz/DeckUI">DeckUI&lt;/a>, will kick an &lt;a href="https://avaloniaui.net/">Avalonia&lt;/a> application which shows a presentation.&lt;/p>
&lt;h1 id="first-some-prior-art">First, some prior art&lt;/h1>
&lt;p>There&amp;rsquo;s already quite a few really nice examples of DSL that use CEs outside of the ones in the core library, the one that immediately comes to mind is &lt;a href="https://github.com/fsprojects/FSHttp">FSHttp&lt;/a>, which uses CEs to declare HTTP requests that are really easy to interpret:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>http &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> POST &lt;span style="color:#e6db74">&amp;#34;https://reqres.in/api/users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CacheControl &lt;span style="color:#e6db74">&amp;#34;no-cache&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> body
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jsonSerialize
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{|&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;morpheus&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> job &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;leader&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Or projects like &lt;a href="https://github.com/pimbrouwers/Validus">Validus&lt;/a> that use the applicative nature of CEs to create powerful validations with a few single lines of code:&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-fsharp:" data-lang="fsharp:">let nameValidator = Check.String.betweenLen 3 64
let firstNameValidator =
ValidatorGroup(nameValidator)
.Then(Check.String.notEquals dto.LastName)
.Build()
validate {
let! first = firstNameValidator &amp;#34;First name&amp;#34; dto.FirstName
and! last = nameValidator &amp;#34;Last name&amp;#34; dto.LastName
and! age = Check.optional (Check.Int.between 1 120) &amp;#34;Age&amp;#34; dto.Age
return {
Name = { First = first; Last = last }
Age = age }
}
&lt;/code>&lt;/pre>&lt;p>So are you wondering how we can do something like this? Well, wonder no more, let&amp;rsquo;s get our hands dirty!&lt;/p>
&lt;h1 id="defining-our-domain">Defining our domain&lt;/h1>
&lt;blockquote>
&lt;p>Psst, in case you&amp;rsquo;d like to see the entire code, it&amp;rsquo;s posted &lt;a href="https://github.com/sleepyfran/sharp-point">here&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>Let&amp;rsquo;s start by defining how we want our DSL to look like. We need to be able to declare two simple things: slides and decks. Slides will represent one individual slide inside of our presentation, while our deck will be the presentation itself and should hold all the slides. Let&amp;rsquo;s get our domain defined:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Slide&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span> Header&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Deck&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span> Title&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">;&lt;/span> Slides&lt;span style="color:#f92672">:&lt;/span> Slide &lt;span style="color:#66d9ef">list&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We&amp;rsquo;ll start by defining simple types that we can expand upon later. We&amp;rsquo;ll start by just supporting a header in the slides, later on we can add content to it as well. For the deck, we&amp;rsquo;ll have a title field which will be the initial view displayed once we load the deck into the program, and a list of slides as defined above.&lt;/p>
&lt;h1 id="implementing-our-dsl">Implementing our DSL&lt;/h1>
&lt;p>With this we can start defining our first computation expression: a slide. Let&amp;rsquo;s add a &lt;code>header&lt;/code> operation that will represent a header inside of a slide later on:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">SlideBuilder&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Yield&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> ()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&amp;lt;&lt;/span>CustomOperation&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;header&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Header&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">,&lt;/span> header&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">:&lt;/span> Slide &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span> Header &lt;span style="color:#f92672">=&lt;/span> header &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> slide &lt;span style="color:#f92672">=&lt;/span> SlideBuilder()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We need to also implement yield since it&amp;rsquo;s a requirement for having custom operations working, but we don&amp;rsquo;t actually want it to do anything so we&amp;rsquo;ll return a unit from it. For the actual header we&amp;rsquo;ll also take a unit as the initial argument and the title assigned to the header. The reason why we&amp;rsquo;re taking a unit as the first parameter is that this parameter usually represents the &lt;em>previous state&lt;/em> of the expression. Taking a unit means that we don&amp;rsquo;t want any previous state and therefore we force the &lt;code>header&lt;/code> operation to be the first one in the expression and also allow to only have one header per slide.&lt;/p>
&lt;p>Looking good! We can now use our slide builder like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>slide &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> header &lt;span style="color:#e6db74">&amp;#34;Hello world!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And if we actually consume the result of the expression we will see that it&amp;rsquo;s a record with the Header field set to what we passed to the operation. Cool, so far so good! We will be adding more stuff to the slides later, but let&amp;rsquo;s now try to define a DSL for the deck itself. As we defined previously, our deck should have two parts: a title for the deck and a list of slides that we will show. Let&amp;rsquo;s start with the title since it&amp;rsquo;s the easy part.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&amp;lt;&lt;/span>RequireQualifiedAccess&lt;span style="color:#f92672">&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeckProperty&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Title &lt;span style="color:#66d9ef">of&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeckBuilder&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Yield&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> ()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Run&lt;span style="color:#f92672">(&lt;/span>DeckProperty.Title title&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span> Title &lt;span style="color:#f92672">=&lt;/span> title&lt;span style="color:#f92672">;&lt;/span> Slides &lt;span style="color:#f92672">=&lt;/span> [] &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&amp;lt;&lt;/span>CustomOperation&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;title&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Title&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">,&lt;/span> title&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> DeckProperty.Title title
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> deck &lt;span style="color:#f92672">=&lt;/span> DeckBuilder()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We will start by defining a &lt;code>DeckProperty&lt;/code> union type which will hold all the different content that a deck can accept. So far we only accept a title, but we&amp;rsquo;ll be accepting slides as well pretty soon so a union case is a better idea than directly translating to our domain record. We then define a yield that takes a unit and returns a unit, just like in the previous expression. The &lt;code>title&lt;/code> custom operation simply produces a value of &lt;code>Title&lt;/code> with the given string and then all that&amp;rsquo;s left is defining a &lt;code>Run&lt;/code> method that takes a prop and produces our domain Deck type, since this is the method that will be run right after our expression finishes, so we can use it to transform the property into our domain record.&lt;/p>
&lt;p>Cool! Trying out our expression so far produces a Deck type with no slides and &amp;ldquo;Test Deck&amp;rdquo; as the title:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>deck &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> title &lt;span style="color:#e6db74">&amp;#34;Test Deck&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, what about if we want to support a &lt;code>slide&lt;/code> inside of our &lt;code>deck&lt;/code>? Can we do that? Let&amp;rsquo;s try it out, let&amp;rsquo;s add the previously defined slide inside of our deck and see what happens:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>deck &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(*
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> ERROR: This control construct may only be used if the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> computation expression builder defines a &amp;#39;Zero&amp;#39; method
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> header &lt;span style="color:#e6db74">&amp;#34;Hello world!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Okay, let&amp;rsquo;s take a step back and try to support &lt;em>yielding&lt;/em> slides inside of our deck:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&amp;lt;&lt;/span>RequireQualifiedAccess&lt;span style="color:#f92672">&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeckProperty&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Title &lt;span style="color:#66d9ef">of&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Slide &lt;span style="color:#66d9ef">of&lt;/span> Slide
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeckBuilder&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Yield&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> ()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Yield&lt;span style="color:#f92672">(&lt;/span>slide&lt;span style="color:#f92672">:&lt;/span> Slide&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> DeckProperty.Slide slide
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Run&lt;span style="color:#f92672">(&lt;/span>prop&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> prop &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> DeckProperty.Title title &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span> Title &lt;span style="color:#f92672">=&lt;/span> title&lt;span style="color:#f92672">;&lt;/span> Slides &lt;span style="color:#f92672">=&lt;/span> [] &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> DeckProperty.Slide slide &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span> Title &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span> Slides &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">[&lt;/span> slide &lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&amp;lt;&lt;/span>CustomOperation&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;title&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Title&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">,&lt;/span> title&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> DeckProperty.Title title
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>By extending our union of properties and adding a &lt;code>Yield&lt;/code> method that accepts a slide and extending the &lt;code>Run&lt;/code> method to support slides, we can now run the code defined above by adding &lt;code>yield&lt;/code> before the &lt;code>slide&lt;/code> expression, and it works as well, but that&amp;rsquo;s not what we want! We want to be able to add expressions without having to yield them.&lt;/p>
&lt;p>In order to do so, we need to implement another method call &lt;code>Delay&lt;/code>, whose signature is &lt;code>(unit -&amp;gt; M&amp;lt;'T&amp;gt;) -&amp;gt; M&amp;lt;'T&amp;gt;&lt;/code>, which in our case would mean that given any function that takes a unit and returns a known wrapped type (like a slide!) we can turn it into our &lt;code>DeckProperty&lt;/code> type. We will also define &lt;code>Combine&lt;/code>, whose signature is &lt;code>M&amp;lt;'T&amp;gt; * M&amp;lt;'T&amp;gt; -&amp;gt; M&amp;lt;'T&amp;gt;&lt;/code>, which is basically merging two properties together in our case, which we need to support declaring multiple properties inside of the DSL (like a title and a slide or just multiple slides):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeckBuilder&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Delay&lt;span style="color:#f92672">(&lt;/span>f&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">unit&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> DeckProperty&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> f ()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Combine&lt;span style="color:#f92672">(&lt;/span>props1&lt;span style="color:#f92672">:&lt;/span> DeckProperty&lt;span style="color:#f92672">,&lt;/span> props2&lt;span style="color:#f92672">:&lt;/span> DeckProperty&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> props2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now you might be looking at that combine and thinking &amp;ldquo;aren&amp;rsquo;t we basically discarding what was previously there?&amp;rdquo; and you&amp;rsquo;re absolutely right, if we try to add two &lt;code>slides&lt;/code> inside of the deck only the latest one will get to stay and the other one will be discarded. Let&amp;rsquo;s fix this by producing a list of properties instead of just one single property:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeckBuilder&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Delay&lt;span style="color:#f92672">(&lt;/span>f&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">unit&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> DeckProperty &lt;span style="color:#66d9ef">list&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> f()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Delay&lt;span style="color:#f92672">(&lt;/span>f&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">unit&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> DeckProperty&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">[&lt;/span>f ()&lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Combine&lt;span style="color:#f92672">(&lt;/span>newProp&lt;span style="color:#f92672">:&lt;/span> DeckProperty&lt;span style="color:#f92672">,&lt;/span> previousProps&lt;span style="color:#f92672">:&lt;/span> DeckProperty &lt;span style="color:#66d9ef">list&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> newProp &lt;span style="color:#f92672">::&lt;/span> previousProps
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> x&lt;span style="color:#f92672">.&lt;/span>Run&lt;span style="color:#f92672">(&lt;/span>props&lt;span style="color:#f92672">:&lt;/span> DeckProperty &lt;span style="color:#66d9ef">list&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> props
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> List.fold
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> deck prop &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> prop &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> DeckProperty.Title title &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span> deck &lt;span style="color:#66d9ef">with&lt;/span> Title &lt;span style="color:#f92672">=&lt;/span> title &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> DeckProperty.Slide slide &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span> deck &lt;span style="color:#66d9ef">with&lt;/span> Slides &lt;span style="color:#f92672">=&lt;/span> slide &lt;span style="color:#f92672">::&lt;/span> deck&lt;span style="color:#f92672">.&lt;/span>Slides &lt;span style="color:#f92672">})&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{&lt;/span> Title &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span> Slides &lt;span style="color:#f92672">=&lt;/span> [] &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> x&lt;span style="color:#f92672">.&lt;/span>Run&lt;span style="color:#f92672">(&lt;/span>prop&lt;span style="color:#f92672">:&lt;/span> DeckProperty&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> x&lt;span style="color:#f92672">.&lt;/span>Run&lt;span style="color:#f92672">([&lt;/span>prop&lt;span style="color:#f92672">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It might look like a bunch of changes but it&amp;rsquo;s easier than it looks. We&amp;rsquo;ve just:&lt;/p>
&lt;ul>
&lt;li>Changed the &lt;code>Delay&lt;/code> method to return a list given one single property and also to support functions that return lists, in which case we simply return the result.&lt;/li>
&lt;li>Changed the &lt;code>Combine&lt;/code> method to take a list as the second parameter, so that we can accept all the previous properties that were added in the deck. That way we can append the new one to all the previous props.&lt;/li>
&lt;li>Created a new &lt;code>Run&lt;/code> method that takes a list instead of a single property, and folds the list of properties into one single deck. This is the method that will get called when the expression finishes, so that we don&amp;rsquo;t have to do the folding later on. We&amp;rsquo;ve also changed the implementation of the original &lt;code>Run&lt;/code> to call the list overload, in case we get a single property, by wrapping the property under a list.&lt;/li>
&lt;/ul>
&lt;p>You might be thinking now &amp;ldquo;does he not know that appending means putting the value at the end of the list and :: definitely does not do that?&amp;rdquo;. Yes, I do! However keep in mind that expressions are evaluated from the bottom up, which means that we&amp;rsquo;ll be combining the last value &lt;em>first&lt;/em> and only afterwards the rest, so that&amp;rsquo;s why pre-pending values actually appends them to the end of the list in the end.&lt;/p>
&lt;p>With this we can add multiple &lt;code>slide&lt;/code> expressions inside of our deck without having to yield anything, cool! However there&amp;rsquo;s one big gap: we can&amp;rsquo;t add our previously defined &lt;code>title&lt;/code> and then add slides, we get the following error:&lt;/p>
&lt;blockquote>
&lt;p>This control construct may only be used if the computation expression builder defines a &amp;lsquo;For&amp;rsquo; method&lt;/p>
&lt;/blockquote>
&lt;p>So let&amp;rsquo;s do that now!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">DeckBuilder&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> x&lt;span style="color:#f92672">.&lt;/span>For&lt;span style="color:#f92672">(&lt;/span>prop&lt;span style="color:#f92672">:&lt;/span> DeckProperty&lt;span style="color:#f92672">,&lt;/span> f&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">unit&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> DeckProperty &lt;span style="color:#66d9ef">list&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x&lt;span style="color:#f92672">.&lt;/span>Combine&lt;span style="color:#f92672">(&lt;/span>prop&lt;span style="color:#f92672">,&lt;/span> f()&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In the docs they specify that the signature for &lt;code>For&lt;/code> is &lt;code>seq&amp;lt;'T&amp;gt; * ('T -&amp;gt; M&amp;lt;'U&amp;gt;) -&amp;gt; seq&amp;lt;M&amp;lt;'U&amp;gt;&amp;gt;&lt;/code>, however that does not force us to specify the first argument as a sequence, it could be any &amp;ldquo;wrapped type&amp;rdquo; of T and since in our case we just have one property and we want to combine it with any function that returns a list of decks, we can just use a single property. This signature we&amp;rsquo;ve added is exactly the same as our &lt;code>Combine&lt;/code> method but taking a function as the last parameter, so we can just call &lt;code>Combine&lt;/code> and evaluate the function immediately.&lt;/p>
&lt;p>And would you look at that, it works!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>deck &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> title &lt;span style="color:#e6db74">&amp;#34;Testing Deck with title&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> header &lt;span style="color:#e6db74">&amp;#34;This works&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> header &lt;span style="color:#e6db74">&amp;#34;...and also this!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> header &lt;span style="color:#e6db74">&amp;#34;Much wow!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>So that concludes our DSL, now let&amp;rsquo;s go over the second part which is actually doing something useful with it.&lt;/p>
&lt;h1 id="a-brief-introduction-to-avaloniafuncui">A brief introduction to Avalonia.FuncUI&lt;/h1>
&lt;p>For the UI part we&amp;rsquo;ll use Avalonia, specifically &lt;a href="https://github.com/fsprojects/Avalonia.FuncUI">FuncUI&lt;/a> which is a more functional-friendly way of creating UIs using Avalonia and F#. I won&amp;rsquo;t get into details of the hows and whys of FuncUI, so if you want to learn more feel free to check out the repo linked above!&lt;/p>
&lt;p>Since we already have a project set-up let&amp;rsquo;s just quickly get an app running, starting with the dependencies, we need the following ones:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-xml" data-lang="xml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;PackageReference&lt;/span> &lt;span style="color:#a6e22e">Include=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Avalonia&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">Version=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;11.0.0-preview3&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;PackageReference&lt;/span> &lt;span style="color:#a6e22e">Include=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Avalonia.Desktop&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">Version=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;11.0.0-preview3&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;PackageReference&lt;/span> &lt;span style="color:#a6e22e">Include=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Avalonia.Themes.Fluent&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">Version=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;11.0.0-preview3&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;PackageReference&lt;/span> &lt;span style="color:#a6e22e">Include=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;JaggerJo.Avalonia.FuncUI&amp;#34;&lt;/span> &lt;span style="color:#a6e22e">Version=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;0.6.0-preview3&amp;#34;&lt;/span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can either add them manually under a &lt;code>&amp;lt;ItemGroup&amp;gt;&lt;/code> in the fsproj file or add them through a NuGet UI if your IDE supports that. Once we have the dependencies ready, it&amp;rsquo;s time to start defining how we want our API to look like.&lt;/p>
&lt;h1 id="abstracting-the-deck-presentation">Abstracting the deck presentation&lt;/h1>
&lt;p>Once a user creates a deck with our DSL, I&amp;rsquo;d like to have a simple method call &lt;code>showPresentation&lt;/code> that takes a deck and takes care of all the heavy lifting needed to get the Avalonia app ready and rendered. This is all great for the consumer, but we need to actually go ahead and define all this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">(* --- Here we will actually render the whole presentation later on --- *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> root deck &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> ctx &lt;span style="color:#f92672">-&amp;gt;&lt;/span> TextBlock.create &lt;span style="color:#f92672">[&lt;/span> TextBlock.text deck&lt;span style="color:#f92672">.&lt;/span>Title &lt;span style="color:#f92672">])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">(* --- Entrypoint --- *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">MainWindow&lt;/span>&lt;span style="color:#f92672">(&lt;/span>deck&lt;span style="color:#f92672">:&lt;/span> Deck&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">as&lt;/span> this &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">inherit&lt;/span> HostWindow()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">base&lt;/span>&lt;span style="color:#f92672">.&lt;/span>Title &lt;span style="color:#f92672">&amp;lt;-&lt;/span> &lt;span style="color:#e6db74">&amp;#34;SharpPoint&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">base&lt;/span>&lt;span style="color:#f92672">.&lt;/span>MinWidth &lt;span style="color:#f92672">&amp;lt;-&lt;/span> &lt;span style="color:#ae81ff">1280&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">base&lt;/span>&lt;span style="color:#f92672">.&lt;/span>MinHeight &lt;span style="color:#f92672">&amp;lt;-&lt;/span> &lt;span style="color:#ae81ff">720&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> this&lt;span style="color:#f92672">.&lt;/span>Padding &lt;span style="color:#f92672">&amp;lt;-&lt;/span> Thickness&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#ae81ff">10&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#ae81ff">30&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#ae81ff">10&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> this&lt;span style="color:#f92672">.&lt;/span>Content &lt;span style="color:#f92672">&amp;lt;-&lt;/span> root deck
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> this&lt;span style="color:#f92672">.&lt;/span>ExtendClientAreaToDecorationsHint &lt;span style="color:#f92672">&amp;lt;-&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">App&lt;/span>&lt;span style="color:#f92672">(&lt;/span>deck&lt;span style="color:#f92672">:&lt;/span> Deck&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">inherit&lt;/span> Application()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> this.&lt;span style="color:#a6e22e">Initialize&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> this&lt;span style="color:#f92672">.&lt;/span>Styles&lt;span style="color:#f92672">.&lt;/span>Add&lt;span style="color:#f92672">(&lt;/span>FluentTheme&lt;span style="color:#f92672">(&lt;/span>baseUri &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">,&lt;/span> Mode &lt;span style="color:#f92672">=&lt;/span> FluentThemeMode.Dark&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> this.&lt;span style="color:#a6e22e">OnFrameworkInitializationCompleted&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> this&lt;span style="color:#f92672">.&lt;/span>ApplicationLifetime &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#f92672">:?&lt;/span> IClassicDesktopStyleApplicationLifetime &lt;span style="color:#66d9ef">as&lt;/span> desktopLifetime &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> mainWindow &lt;span style="color:#f92672">=&lt;/span> MainWindow&lt;span style="color:#f92672">(&lt;/span>deck&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> desktopLifetime&lt;span style="color:#f92672">.&lt;/span>MainWindow &lt;span style="color:#f92672">&amp;lt;-&lt;/span> mainWindow
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> ()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> showPresentation deck &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> AppBuilder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .Configure&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> App&lt;span style="color:#f92672">(&lt;/span>deck&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>UsePlatformDetect()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>UseSkia()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>StartWithClassicDesktopLifetime&lt;span style="color:#f92672">([||])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> ignore
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In our &lt;code>showPresentation&lt;/code> function we take a deck and we pass it all the way down while we configure the Avalonia app for starting by loading the base styles (I chose the default fluent theme) and setting our root view as the main content of a 1280x720 window. That &lt;code>ExtendClientAreaToDecorationsHint&lt;/code> hides the chrome of the window so that we have everything covered by the content, so that&amp;rsquo;s why we also need a little padding on the content to not show them over the window controls. If we now use the &lt;code>showPresentation&lt;/code> function with a deck, it&amp;rsquo;ll show our title!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>deck &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> title &lt;span style="color:#e6db74">&amp;#34;A test&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide &lt;span style="color:#f92672">{&lt;/span> header &lt;span style="color:#e6db74">&amp;#34;Hello world!&amp;#34;&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide &lt;span style="color:#f92672">{&lt;/span> header &lt;span style="color:#e6db74">&amp;#34;Wow!&amp;#34;&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide &lt;span style="color:#f92672">{&lt;/span> header &lt;span style="color:#e6db74">&amp;#34;Much wow!&amp;#34;&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">|&amp;gt;&lt;/span> showPresentation
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://sleepyfran.github.io/blog/blog/img/ce-in-fsharp/initial-app-running.png" alt="A screenshot of the app running with just a title saying &amp;amp;ldquo;A test&amp;amp;rdquo;">&lt;/p>
&lt;p>Let&amp;rsquo;s move this first slide to its own component and start the process of handling more slides. I&amp;rsquo;ll declare a state which holds the current slide and use it on the root component. I&amp;rsquo;ll also declare a separate component for the initial slide where I just display a big text with the title of the slide centered in the screen. We&amp;rsquo;ll declare the current slide as a separate type to have a clear separation between what&amp;rsquo;s the initial slide and an actual slide that the user created instead of having to do tricks with the indexes of the slides:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">private&lt;/span> CurrentSlide &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Initial
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Slide &lt;span style="color:#66d9ef">of&lt;/span> index&lt;span style="color:#f92672">:&lt;/span> int
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">private&lt;/span> GlobalState &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span> CurrentSlide&lt;span style="color:#f92672">:&lt;/span> IWritable&lt;span style="color:#f92672">&amp;lt;&lt;/span>CurrentSlide&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> state &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span> CurrentSlide &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> State&lt;span style="color:#f92672">&amp;lt;&lt;/span>CurrentSlide&lt;span style="color:#f92672">&amp;gt;(&lt;/span>Initial&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> initialSlide deck &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component.create &lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;initial-slide&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.horizontalAlignment HorizontalAlignment.Center
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.verticalAlignment VerticalAlignment.Center
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.children &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.fontSize &lt;span style="color:#ae81ff">72&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.fontWeight FontWeight.Bold
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.text deck&lt;span style="color:#f92672">.&lt;/span>Title
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> private root deck &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> ctx &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> currentSlide &lt;span style="color:#f92672">=&lt;/span> ctx&lt;span style="color:#f92672">.&lt;/span>usePassedRead state&lt;span style="color:#f92672">.&lt;/span>CurrentSlide
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> currentSlide&lt;span style="color:#f92672">.&lt;/span>Current &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Initial &lt;span style="color:#f92672">-&amp;gt;&lt;/span> initialSlide deck
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> failwith &lt;span style="color:#e6db74">&amp;#34;Coming soon!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The reason for declaring a global state instead of one scoped to the root view is that Avalonia by default listens to key events in the whole application window and if we want to listen to events inside of one component, we have to manually focus it. So let&amp;rsquo;s just declare our state globally and modify it from the window.&lt;/p>
&lt;p>We obviously have a couple of holes to fill in our implementation, so let&amp;rsquo;s do that now!&lt;/p>
&lt;h2 id="keyboard-navigation">Keyboard navigation&lt;/h2>
&lt;p>Let&amp;rsquo;s start by just displaying a mocked slide that will display its index so that we can get navigation working and then we can worry about actually displaying what the user chose. We&amp;rsquo;ll assign the component the &lt;em>slide-x&lt;/em> ID so that FuncUI can &lt;a href="https://funcui.avaloniaui.net/components/component-lifetime#component-identity-key">properly detect changes between the different views&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> private slide &lt;span style="color:#f92672">(&lt;/span>index&lt;span style="color:#f92672">:&lt;/span> int&lt;span style="color:#f92672">)&lt;/span> slide &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component.create&lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">$&lt;/span>&lt;span style="color:#e6db74">&amp;#34;slide-{index}&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.text &lt;span style="color:#f92672">$&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Slide number {index}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">:&amp;gt;&lt;/span> IView
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> private root deck &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> ctx &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> currentSlide&lt;span style="color:#f92672">.&lt;/span>Current &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Initial &lt;span style="color:#f92672">-&amp;gt;&lt;/span> initialSlide deck
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Slide idx &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> deck&lt;span style="color:#f92672">.&lt;/span>Slides
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> List.item idx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> slide idx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If we change the initial state to one of the slides, we&amp;rsquo;ll see a simple slide displaying its index. Cool! Now that we have that in place we can implement navigation between slides with the keyboard. For that let&amp;rsquo;s modify the MainWindow declaration to add a key down handler:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> hasSlideAvailableIn idx slides &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slides
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> List.tryItem idx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> Option.isSome
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">MainWindow&lt;/span>&lt;span style="color:#f92672">(&lt;/span>deck&lt;span style="color:#f92672">:&lt;/span> Deck&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">as&lt;/span> this &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">override&lt;/span> this.&lt;span style="color:#a6e22e">OnKeyDown&lt;/span> &lt;span style="color:#66d9ef">event&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> current &lt;span style="color:#f92672">=&lt;/span> state&lt;span style="color:#f92672">.&lt;/span>CurrentSlide&lt;span style="color:#f92672">.&lt;/span>Current
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> current&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">event&lt;/span>&lt;span style="color:#f92672">.&lt;/span>Key &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Slide &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">,&lt;/span> Key.Left &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* Go back to the initial slide *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Initial
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Initial&lt;span style="color:#f92672">,&lt;/span> Key.Right &lt;span style="color:#66d9ef">when&lt;/span> List.isEmpty deck&lt;span style="color:#f92672">.&lt;/span>Slides &lt;span style="color:#f92672">|&amp;gt;&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* Go to the first slide (if any) *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Slide &lt;span style="color:#ae81ff">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Slide index&lt;span style="color:#f92672">,&lt;/span> Key.Left &lt;span style="color:#66d9ef">when&lt;/span> deck&lt;span style="color:#f92672">.&lt;/span>Slides &lt;span style="color:#f92672">|&amp;gt;&lt;/span> hasSlideAvailableIn &lt;span style="color:#f92672">(&lt;/span>index &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* Go to the previous slide (if any) *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> index &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> Slide
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Slide index&lt;span style="color:#f92672">,&lt;/span> Key.Right &lt;span style="color:#66d9ef">when&lt;/span> deck&lt;span style="color:#f92672">.&lt;/span>Slides &lt;span style="color:#f92672">|&amp;gt;&lt;/span> hasSlideAvailableIn &lt;span style="color:#f92672">(&lt;/span>index &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* Go to the next slide (if any) *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> index &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> Slide
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> current
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> state&lt;span style="color:#f92672">.&lt;/span>CurrentSlide&lt;span style="color:#f92672">.&lt;/span>Set
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I love how succinct pattern matching can be when combined with tuples! There&amp;rsquo;s a bit of logic required to not go out of bounds from the list and also to handle the initial slide gracefully, so we basically pattern match through all the possibilities:&lt;/p>
&lt;ul>
&lt;li>Pressing the right key while on the initial slide should go to the first slide of the presentation if there&amp;rsquo;s any.&lt;/li>
&lt;li>Pressing right when there&amp;rsquo;s more slides in the presentation should advance the current slide.&lt;/li>
&lt;li>Pressing left when there&amp;rsquo;s still slides before the current one should go back to the previous.&lt;/li>
&lt;li>Pressing left when we&amp;rsquo;re in the first user-declared slide should go back to the initial.&lt;/li>
&lt;li>Otherwise, keep it as it is.&lt;/li>
&lt;/ul>
&lt;p>I&amp;rsquo;ve abstracted the &amp;ldquo;if any&amp;rdquo; slide in a separate function to make the match easier to read. So now we can navigate between all our slides, awesome! Let&amp;rsquo;s go and display the slides now.&lt;/p>
&lt;h2 id="displaying-the-actual-slides">Displaying the actual slides&lt;/h2>
&lt;p>The only thing left is displaying the actual content of the slides instead of the mocked ones we created before. Since we only support the header we have it easy:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> private slide &lt;span style="color:#f92672">(&lt;/span>index&lt;span style="color:#f92672">:&lt;/span> int&lt;span style="color:#f92672">)&lt;/span> slide &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component.create&lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">$&lt;/span>&lt;span style="color:#e6db74">&amp;#34;slide-{index}&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.children &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> System.String.IsNullOrEmpty slide&lt;span style="color:#f92672">.&lt;/span>Header &lt;span style="color:#f92672">|&amp;gt;&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#66d9ef">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.fontSize &lt;span style="color:#ae81ff">48&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.fontWeight FontWeight.Bold
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.text slide&lt;span style="color:#f92672">.&lt;/span>Header
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">:&amp;gt;&lt;/span> IView
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And there we go, it works!&lt;/p>
&lt;p>&lt;img src="https://sleepyfran.github.io/blog/blog/img/ce-in-fsharp/slides-app.gif" alt="A video recording of the app showing three slides that read &amp;amp;ldquo;SharpPoint: Presentations made sharper&amp;amp;rdquo; as the title, &amp;amp;ldquo;This is the first slide&amp;amp;rdquo;, &amp;amp;ldquo;&amp;amp;hellip;Wow, this is the second&amp;amp;rdquo; and &amp;amp;ldquo;NO WAY, a third?!&amp;amp;rdquo;">&lt;/p>
&lt;h1 id="adding-more-stuff">Adding more stuff!&lt;/h1>
&lt;p>Of course only supporting titles and headers would make for very boring presentations, so let&amp;rsquo;s spicy everything up a bit by adding support for text and images inside of slides. Starting, of course, by modifying our domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">SlideContent&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Text &lt;span style="color:#66d9ef">of&lt;/span> text&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Image &lt;span style="color:#66d9ef">of&lt;/span> url&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Slide&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span> Header&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">;&lt;/span> Content&lt;span style="color:#f92672">:&lt;/span> SlideContent &lt;span style="color:#66d9ef">list&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This basically defines a new &lt;em>slide content&lt;/em> which can be any text or a remote image. Let&amp;rsquo;s go over supporting this in our DSL now.&lt;/p>
&lt;p>Unfortunately we didn&amp;rsquo;t make our slide DSL very easy to expand because the &lt;code>header&lt;/code> property already returns a pre-made slide. Let&amp;rsquo;s fix this by following the same pattern we did to create the deck DSL and make each individual operation return a property that we&amp;rsquo;ll merge together later inside of the &lt;code>Run&lt;/code> method.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">[&amp;lt;&lt;/span>RequireQualifiedAccess&lt;span style="color:#f92672">&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">SlideProperty&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Header &lt;span style="color:#66d9ef">of&lt;/span> header&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Content &lt;span style="color:#66d9ef">of&lt;/span> content&lt;span style="color:#f92672">:&lt;/span> SlideContent
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">SlideBuilder&lt;/span>() &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Yield&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> ()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> x&lt;span style="color:#f92672">.&lt;/span>Run&lt;span style="color:#f92672">(&lt;/span>props&lt;span style="color:#f92672">:&lt;/span> SlideProperty &lt;span style="color:#66d9ef">list&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> props
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> List.fold
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> slide prop &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> prop &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> SlideProperty.Header header &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span> slide &lt;span style="color:#66d9ef">with&lt;/span> Header &lt;span style="color:#f92672">=&lt;/span> header &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> SlideProperty.Content content &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span> slide &lt;span style="color:#66d9ef">with&lt;/span> Content &lt;span style="color:#f92672">=&lt;/span> content &lt;span style="color:#f92672">::&lt;/span> slide&lt;span style="color:#f92672">.&lt;/span>Content &lt;span style="color:#f92672">})&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">{&lt;/span> Header &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span> Content &lt;span style="color:#f92672">=&lt;/span> [] &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&amp;lt;&lt;/span>CustomOperation&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;header&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Header&lt;span style="color:#f92672">(&lt;/span>()&lt;span style="color:#f92672">,&lt;/span> header&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">[&lt;/span> SlideProperty.Header header &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&amp;lt;&lt;/span>CustomOperation&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;text&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Text&lt;span style="color:#f92672">(&lt;/span>prev&lt;span style="color:#f92672">:&lt;/span> SlideProperty &lt;span style="color:#66d9ef">list&lt;/span>&lt;span style="color:#f92672">,&lt;/span> text&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">(&lt;/span>Text text &lt;span style="color:#f92672">|&amp;gt;&lt;/span> SlideProperty.Content&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">::&lt;/span> prev
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">[&amp;lt;&lt;/span>CustomOperation&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;image&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> &lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#f92672">_.&lt;/span>Image&lt;span style="color:#f92672">(&lt;/span>prev&lt;span style="color:#f92672">:&lt;/span> SlideProperty &lt;span style="color:#66d9ef">list&lt;/span>&lt;span style="color:#f92672">,&lt;/span> url&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">(&lt;/span>Image url &lt;span style="color:#f92672">|&amp;gt;&lt;/span> SlideProperty.Content&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">::&lt;/span> prev
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Good news is this one is much easier than the deck builder because we don&amp;rsquo;t have to accept any external expressions, only custom operations, so we don&amp;rsquo;t need to implement &lt;code>Delay&lt;/code>, &lt;code>Combine&lt;/code> or &lt;code>For&lt;/code>. We simply define two extra custom operations that take the previous declared properties and pre-pends the new content. Then, in the &lt;code>Run&lt;/code> method, we fold the properties similarly to how we did it in the deck builder to create our domain slide type.&lt;/p>
&lt;h2 id="supporting-the-new-properties-in-the-ui">Supporting the new properties in the UI&lt;/h2>
&lt;p>Now to support this into the UI, we need to modify the slide component that we created earlier. Since the content of a slide is a list, let&amp;rsquo;s map each type of content into an Avalonia view and yield it back into the StackPanel&amp;rsquo;s children. For the text, it&amp;rsquo;s really easy:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> private slide &lt;span style="color:#f92672">(&lt;/span>index&lt;span style="color:#f92672">:&lt;/span> int&lt;span style="color:#f92672">)&lt;/span> slide &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component.create&lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">$&lt;/span>&lt;span style="color:#e6db74">&amp;#34;slide-{index}&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> StackPanel.children &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">(* ... *)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">yield&lt;/span>&lt;span style="color:#f92672">!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> slide&lt;span style="color:#f92672">.&lt;/span>Content
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> List.map &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> content &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> content &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Text text &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.fontSize &lt;span style="color:#ae81ff">24&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.text text
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#f92672">:&amp;gt;&lt;/span> IView
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Image url &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> image url
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">:&amp;gt;&lt;/span> IView
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>For the image we&amp;rsquo;ll need a bit more ceremony. First, let&amp;rsquo;s steal one of the custom hooks defined in the &lt;a href="https://github.com/fsprojects/Avalonia.FuncUI/blob/master/src/Examples/Component%20Examples/Examples.ContactBook/Views.fs#L20">Avalonia FuncUI&amp;rsquo;s examples&lt;/a> to deal with async code a bit more easily. This will basically wrap an async block, execute it right after the component is created and expose the async deferred status. Next, we will define the actual function to fetch an image and transform it into a Bitmap that Avalonia can display and finally we&amp;rsquo;ll consume all this in a component that runs the initial hook and displays a loader when the async hook reports &lt;em>pending&lt;/em>, an error when it fails and display the actual image when it finishes resolving:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fsharp" data-lang="fsharp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Deferred&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">&amp;#39;&lt;/span>t&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> NotStartedYet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Pending
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Resolved &lt;span style="color:#66d9ef">of&lt;/span> &lt;span style="color:#66d9ef">&amp;#39;&lt;/span>t
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Failed &lt;span style="color:#66d9ef">of&lt;/span> &lt;span style="color:#66d9ef">exn&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">IComponentContext&lt;/span> &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">member&lt;/span> this.&lt;span style="color:#a6e22e">useAsync&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">&amp;#39;&lt;/span>signal&lt;span style="color:#f92672">&amp;gt;(&lt;/span>init&lt;span style="color:#f92672">:&lt;/span> Async&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">&amp;#39;&lt;/span>signal&lt;span style="color:#f92672">&amp;gt;)&lt;/span> &lt;span style="color:#f92672">:&lt;/span> IWritable&lt;span style="color:#f92672">&amp;lt;&lt;/span>Deferred&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">&amp;#39;&lt;/span>signal&lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> state &lt;span style="color:#f92672">=&lt;/span> this&lt;span style="color:#f92672">.&lt;/span>useState &lt;span style="color:#f92672">(&lt;/span>Deferred.NotStartedYet&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> this&lt;span style="color:#f92672">.&lt;/span>useEffect &lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handler &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">fun&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> state&lt;span style="color:#f92672">.&lt;/span>Current &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Deferred.NotStartedYet &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> state&lt;span style="color:#f92672">.&lt;/span>Set Deferred.Pending
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Async.StartImmediate &lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> async &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let!&lt;/span> result &lt;span style="color:#f92672">=&lt;/span> Async.Catch init
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> result &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Choice1Of2 value &lt;span style="color:#f92672">-&amp;gt;&lt;/span> state&lt;span style="color:#f92672">.&lt;/span>Set &lt;span style="color:#f92672">(&lt;/span>Deferred.Resolved value&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Choice2Of2 &lt;span style="color:#66d9ef">exn&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> state&lt;span style="color:#f92672">.&lt;/span>Set &lt;span style="color:#f92672">(&lt;/span>Deferred.Failed &lt;span style="color:#66d9ef">exn&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#f92672">_&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">),&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> triggers &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">[&lt;/span> EffectTrigger.AfterInit &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> state
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> loadImage &lt;span style="color:#f92672">(&lt;/span>url&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> async &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">use&lt;/span> httpClient &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> HttpClient()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let!&lt;/span> bytes &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> url
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> httpClient&lt;span style="color:#f92672">.&lt;/span>GetByteArrayAsync
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> Async.AwaitTask
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">use&lt;/span> stream &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> MemoryStream&lt;span style="color:#f92672">(&lt;/span>bytes&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Bitmap&lt;span style="color:#f92672">(&lt;/span>stream&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> private image url &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Component.create &lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">$&lt;/span>&lt;span style="color:#e6db74">&amp;#34;image-{url}&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">fun&lt;/span> ctx &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> image &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> loadImage url
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&amp;gt;&lt;/span> ctx&lt;span style="color:#f92672">.&lt;/span>useAsync
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">match&lt;/span> image&lt;span style="color:#f92672">.&lt;/span>Current &lt;span style="color:#66d9ef">with&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Deferred.Resolved bitmap &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Image.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Image.source bitmap
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Image.maxHeight &lt;span style="color:#ae81ff">300&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Deferred.Failed e &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.text &lt;span style="color:#f92672">$&lt;/span>&lt;span style="color:#e6db74">&amp;#34;{e.Message}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> TextBlock.foreground Brushes.Red
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">|&lt;/span> Deferred.Pending &lt;span style="color:#f92672">|&lt;/span> Deferred.NotStartedYet &lt;span style="color:#f92672">-&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ProgressBar.create &lt;span style="color:#f92672">[&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ProgressBar.isEnabled &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ProgressBar.isIndeterminate &lt;span style="color:#66d9ef">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And behold, our little presentation DSL is ready to be used!
&lt;img src="https://sleepyfran.github.io/blog/blog/img/ce-in-fsharp/final-app.gif" alt="A video recording of the app showing the final app with text support and image loading&amp;quot;">&lt;/p>
&lt;h1 id="final-words">Final words&lt;/h1>
&lt;p>Well, that was quite a ride! I definitely did not expect to have as much fun as I ended up having. There&amp;rsquo;s of course still tons of things that we could support: displaying code, GIF images, layout support&amp;hellip; but we&amp;rsquo;ll leave all that for the future. For now, I hope this post will make you consider using CEs for your next DSL!&lt;/p>
&lt;p>As I mentioned above, the entire code is in a separate repo, so if you want to check it out you can do so here:&lt;/p>
&lt;p>&lt;a href="https://github.com/sleepyfran/sharp-point">SharpPoint repo&lt;/a>&lt;/p></content></item></channel></rss>